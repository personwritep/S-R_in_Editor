// ==UserScript==
// @name        S-R in Editor ‚≠ê
// @namespace        http://tampermonkey.net/
// @version        3.6
// @description        ÈÄöÂ∏∏Á∑®ÈõÜÊû†„ÅßÂÆüË°å„Åß„Åç„Çã Ê§úÁ¥¢ / ÁΩÆÊèõ „ÉÑ„Éº„É´
// @author        Ameba Blog User
// @match        https://blog.ameba.jp/ucs/entry/srventry*
// @exclude        https://blog.ameba.jp/ucs/entry/srventrylist.do*
// @icon        https://www.google.com/s2/favicons?sz=64&domain=ameba.jp
// @grant        none
// @updateURL        https://github.com/personwritep/S-R_in_Editor/raw/main/S-R_in_Editor.user.js
// @downloadURL        https://github.com/personwritep/S-R_in_Editor/raw/main/S-R_in_Editor.user.js
// ==/UserScript==


let retry=0;
let interval=setInterval(wait_target, 100);
function wait_target(){
    retry++;
    if(retry>10){ // „É™„Éà„É©„Ç§Âà∂Èôê 10Âõû 1sec
        clearInterval(interval); }
    let target=document.getElementById('cke_1_contents'); // Áõ£Ë¶ñ target
    if(target){
        clearInterval(interval);
        main(); }}



function main(){
    let p_flag; // Process
    let t_flag; // TEXTÂá¶ÁêÜ
    let t_or_h=1; // TEXT„ÉªHTMLÈÅ∏Êäû„Çπ„Ç§„ÉÉ„ÉÅÁî®„Éï„É©„Ç∞
    let arg_t_or_h; // TEXT„ÉªHTMLÈÅ∏Êäû„ÅåÂøÖË¶Å„Å™Â†¥Âêà
    let count_t;
    let count_h;
    let buffer;
    let buffer_arr=[];
    let avoid=[];
    let caution;
    let hk; // „Éè„Ç§„É©„Ç§„ÉàË¶ÅÁ¥†„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
    let native_hk; // „Éï„Ç©„Éº„Ç´„ÇπË¶ÅÁ¥†„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂ±•Ê≠¥
    let editor_iframe;
    let iframe_doc;
    let iframe_html;
    let iframe_body;
    let js_cover;
    let panel=0; // s_container „ÅÆË°®Á§∫„Éï„É©„Ç∞

    let search_box;
    let search_word;
    let search_word_es;
    let replace_box;
    let replace_word;
    let result_box;
    let s_1;
    let s_2;
    let s_3;
    let s_4;
    let s_5;
    let s_6;
    let s_7;
    let s_8;
    let s_9;


    let sr_data=[]; // ÈÄ£Á∂öÂá¶ÁêÜ„É¢„Éº„Éâ„ÅÆÊ§úÁ¥¢/ÁΩÆÊèõ„Éá„Éº„Çø„ÅÆÁôªÈå≤

    reg_set();

    function reg_set(){
        let read_json=localStorage.getItem('sr_editor'); // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏ ‰øùÂ≠òÂêç
        sr_data=JSON.parse(read_json);
        if(sr_data==null){
            sr_data=['0', '1', '', '']; }} // ÈÄ£Á∂öÂá¶ÁêÜ„É¢„Éº„Éâ„Äå0„ÄçÈÄ£Á∂öÂá¶ÁêÜOFF„Äå1„Äç„ÅØ‰∏ÄÊã¨Âá¶ÁêÜ



    let cke_1_contents=document.getElementById('cke_1_contents'); // Áõ£Ë¶ñ target
    let monitor=new MutationObserver(catch_key);
    monitor.observe(cke_1_contents, {childList: true}); // „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàÂæÖÂèó„ÅëÈñãÂßã

    catch_key();

    function catch_key(){
        search_box=document.querySelector('#search_box');
        editor_iframe=document.querySelector('.cke_wysiwyg_frame');

        if(editor_iframe){ //„ÄåÈÄöÂ∏∏Ë°®Á§∫„Äç„ÅÆÂ†¥Âêà
            if(search_box){
                add_mu_style(); // mu„Çø„Ç∞Áî® style„Çíiframe„Å´ÂÜçË®≠ÂÆö
                search_box.disabled=false; }

            document.addEventListener("keydown", check_key); // document„ÅØÂÖà„Å´ÊåáÂÆö
            iframe_doc=editor_iframe.contentWindow.document;
            if(iframe_doc){
                iframe_doc.addEventListener("keydown", check_key); } // iframe„ÅØÂæå„Å´ÊåáÂÆö

            function check_key(event){
                if(event.ctrlKey==true){
                    if(event.keyCode==123){
                        if(p_flag!=3){ // ÁΩÆÊèõ„ÉÅ„Çß„ÉÉ„ÇØÊôÇ„Åß„Å™„Åë„Çå„Å∞„ÄåCtrl+F12„Äç„ÅßON/OFF
                            event.stopImmediatePropagation();
                            search_replace();
                            if(!editor_iframe){
                                if_html(); }}}
                    else if(event.keyCode==13){
                        if(p_flag==3){
                            event.stopImmediatePropagation();
                            pusher(); }
                        else{
                            event.stopImmediatePropagation();
                            if(event.altKey){
                                delete_mu();
                                publish(); }}}}
                if(event.keyCode==27){
                    if(p_flag==3){ // ÁΩÆÊèõ„ÉÅ„Çß„ÉÉ„ÇØÊôÇ„Å´„ÄåEsc„Äç„ÅßÁΩÆÊèõ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíËß£Èô§=UNDO
                        event.preventDefault();
                        out_p_flag3(); }}
                if(event.keyCode==9){
                    if(p_flag==0){ // Á∑®ÈõÜÊôÇ„Å´Á∑®ÈõÜÊû†„Åã„Çâ„ÄåTab„Äç„ÅßÊ§úÁ¥¢„Å´Êàª„Çã
                        event.preventDefault();
                        search_box.focus(); }}
                if(event.keyCode==9 || event.keyCode==16 || event.keyCode==17 ||
                   event.keyCode==18 || event.keyCode==19 || event.keyCode==32){
                    if(p_flag==3){ // ÁΩÆÊèõ„ÉÅ„Çß„ÉÉ„ÇØÊôÇ„Å´„ÄåTab/Shift/Ctrl/Alt/Pause/Space„Äç„ÇíÁÑ°ÂäπÂåñ
                        event.preventDefault(); }}}
        } //„ÄåÈÄöÂ∏∏Ë°®Á§∫„Äç„ÅÆÂ†¥Âêà

        else{
            if_html(); } //„ÄåHTMLË°®Á§∫„Äç„ÅÆÂ†¥Âêà


        function out_p_flag3(){ // ÁΩÆÊèõ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíËß£Èô§„Åô„Çã
            iframe_body.innerHTML=buffer; // ÁΩÆÊèõÂá¶ÁêÜ„ÇíUNDO ‚èπ
            get_search();
            js_cover_remove();
            s_8.style.display='none';
            reset_mu_style();
            if(t_flag>0){ //„Äåbuffer„Äç„ÇíÊàª„Åó„Åü„ÅÆ„ÅßÂÜçÂ∫¶„Éè„Ç§„É©„Ç§„ÉàË°®Á§∫
                t_flag=1;
                t_process(); //üî≥RegExp
                next(hk); } // UNDOÊôÇ„ÅÆÂ∑°ÂõûË°®Á§∫
            replace_box.focus();
            p_flag=2; } // 2=ÁΩÆÊèõÂÖ•Âäõ


        function if_html(){ //„ÄåHTMLË°®Á§∫„Äç„ÇíÈñã„ÅÑ„ÅüÂ†¥Âêà„ÅÆ„ÇØ„É≠„Éº„Ç∫Âá¶ÁêÜ
            let s_container=document.querySelector('#s_container');
            if(s_container){
                search_box.disabled=true;
                result_box.textContent='„ÄÄ';
                s_1.style.display='none';
                replace_box.style.display='none';
                replace_box.value='';
                s_2.style.display='none';
                s_3.style.display='none';
                s_4.style.display='none';
                s_5.style.display='none';
                s_8.style.display='none';
                t_flag=0;
                p_flag=0; }}


        function pusher(){
            s_2.click(); }

    } // catch_key



    function disp_s_container(){
        monitor.disconnect(); // MutationObserver„Çí Ëµ∑ÂãïË°®Á§∫„Å´ÂèçÂøú„Åï„Åõ„Å™„ÅÑ
        let insert_div=
            '<div id="s_container">'+
            '<input id="search_box" placeholder=" Ê§úÁ¥¢ÊñáÂ≠ó" autocomplete="off">'+
            '<span id="result">„ÄÄ</span>'+
            '<span class="s_sw s_6">‚ñ≤ Caution: '+
            '<span class="c_nb">nbsp</span> <span class="c_lt">&lt</span> '+
            '<span class="c_gt">&gt</span> <span class="c_am">&amp;</span></span>'+
            '<span class="s_sw s_1">„ÄÄ</span>'+
            '<input id="replace_box" placeholder=" ÁΩÆÊèõÊñáÂ≠ó" autocomplete="off">'+
            '<span class="s_sw s_2">OK</span>'+
            '<span class="s_sw s_3">UNDO</span>'+
            '<span class="s_sw s_4"></span>'+
            '<span class="s_sw s_5"></span>'+
            '<span class="s_sw s_7">‚úñ Èñâ„Åò„Çã</span>'+
            '<span class="s_sw s_8">C</span>'+
            '<span class="s_sw s_9">?</span>'+
            '</div>';

        let l_body=document.querySelector('body.l-body');
        if(!l_body.querySelector('#s_container')){
            l_body.insertAdjacentHTML('beforeend', insert_div); }

        let insert_style=
            '<style id="s_r_style">'+
            '#s_container { position: absolute; top: 12px; left: calc(50% - 490px); '+
            'min-width: 928px; padding: 6px 35px 6px 15px; background: #fff; '+
            'border: 1px solid #aaa; border-radius: 4px; z-index: 11; }'+
            '#search_box { width: 210px; }'+
            '#s_container * { user-select: none; }'+
            '#replace_box { width: 210px; display: none; }'+
            '::placeholder { font-size: 15px; color: #bbb; }'+
            '#s_container input:disabled { color: #000; background: #eef1f3; }'+
            '#s_container input { font-size: 16px; padding: 2px 6px 0; -moz-appearance: none; }'+
            '#result { display: inline-block; min-width: 50px; padding: 4px 6px 2px; '+
            'margin-left: 5px; border: 1px solid #aaa; font-size: 16px; }'+
            '.s_sw { display: inline-block; vertical-align: -9px; font-size: 15px; '+
            'padding: 5px 8px 2px; border: 1px solid #aaa; overflow: hidden; }'+
            '.s_1 { margin: 0 15px; min-width: 4em; display: none; }'+
            '.s_1 span { color: #fff; }'+
            '.s_2, .s_3, .s_4 { color:#fff; background: #1e88e5; cursor: pointer; display: none; }'+
            '.s_3, .s_5 { margin-left: 5px; }'+
            '.s_2, .s_4 {margin-left: 15px; }'+
            '.s_5 { position: fixed; top: 70px; right: calc(50% - 490px); width: 175px; '+
            'padding: 10px 10px 8px 20px; border-radius: 4px; background: #e3f2fd; display: none; }'+
            '.s_5 c { display: inline-block; height: 21px; margin: 5px 3px; padding: 0 3px; '+
            'outline: 1px solid #aaa; line-height: 24px; background: #fff; }'+
            '.s_6 { margin-left: -1px; background: #ffcc00; display: none; white-space: nowrap; }'+
            '.s_6:hover { width: auto !important; padding: 5px 8px 2px !important; }'+
            '.c_nb, .c_lt, .c_gt, .c_am { font-weight: bold; }'+
            '.s_7 { position: absolute; right: 38px; }'+
            '.s_8 { margin-left: 20px; color: #fff; background: #ddd; cursor: pointer; display: none; }'+
            '.s_9 { position: absolute; top: 11px; right: 8px; padding: 3px 5px 0; line-height: 16px; '+
            'font-weight: bold; color: #fff; border-radius: 30px; background: #aaa; cursor: pointer; }'+
            '.js_cover { position: fixed; top: 0; width: 100%; height: 100%; '+
            'background: rgba(0, 0, 0, .6); z-index: 10; display: none; }'+
            '</style>';

        if(!document.querySelector('#s_r_style')){
            document.body.insertAdjacentHTML('beforeend', insert_style); }

        add_mu_style(); // mu„Çø„Ç∞„ÇíË®≠ÂÆö

        monitor.observe(cke_1_contents, {childList: true});

    } // disp_s_container() „ÄåÈñãÂßãÂá¶ÁêÜ„Äç


    function s_container_remove(n){
        let s_container=document.querySelector('#s_container');
        monitor.disconnect(); // MutationObserver„Çí Ëµ∑ÂãïË°®Á§∫„Å´ÂèçÂøú„Åï„Åõ„Å™„ÅÑ
        delete_mu();
        native_hk=-1; // ÂàùÊúüÂåñüÖø
        if(n==1){ //„ÄåÈñâ„Åò„Çã„Äç‰∏ä„ÅÆ„Éù„Ç§„É≥„Çø„Åß „Éó„É¨„Éì„É•„Éº„ÇíÊ©üËÉΩ„Åï„Åõ„Å™„ÅÑ
            safe_cover(); }
        s_container.remove();
        panel=0;
        title_sw_remove(); // üü©
        safe_cover_off();
        monitor.observe(cke_1_contents, {childList: true});

        function safe_cover(){
            let p_title=document.querySelector('.p-title');
            if(p_title){
                p_title.style.zIndex='11'; }}

        function safe_cover_off(){
            let p_title=document.querySelector('.p-title');
            if(p_title){
                p_title.onmouseout=function(){
                    p_title.style.zIndex='0'; }}}

    } // s_container_remove() „ÄåÁµÇ‰∫ÜÂá¶ÁêÜ„Äç



    function disp_js_cover(){
        monitor.disconnect(); // MutationObserver„Çí Ëµ∑ÂãïË°®Á§∫„Å´ÂèçÂøú„Åï„Åõ„Å™„ÅÑ
        let cover='<div class="js_cover"></div>';
        if(!document.querySelector('.js_cover')){
            document.querySelector('#js-container').insertAdjacentHTML('beforeend', cover); }

        js_cover=document.querySelector('.js_cover'); // js_cover„ÇíÂèñÂæó
        monitor.observe(cke_1_contents, {childList: true}); }


    function js_cover_remove(){
        js_cover.style.display='none';
        cke_1_contents.style.zIndex='3';
        iframe_body.contentEditable='true'; // Á∑®ÈõÜÂèØËÉΩ„Å´„Åô„Çã
        search_box.disabled=false;
        replace_box.disabled=false;
        s_2.style.display='none';
        s_3.style.display='none';
        s_4.style.display='none';
        s_5.style.display='none';
        s_7.style.display='inline-block'; }



    function search_replace(){
        editor_iframe=document.querySelector('.cke_wysiwyg_frame');

        if(editor_iframe){ //„ÄåÈÄöÂ∏∏Ë°®Á§∫„Äç„ÅÆÂ†¥Âêà
            iframe_doc=editor_iframe.contentWindow.document;
            iframe_html=iframe_doc.querySelector('html');
            iframe_body=iframe_doc.querySelector('body.cke_editable'); }

        disp_js_cover();

        let s_container=document.querySelector('#s_container');
        if(s_container){ // #s_container „Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄåCtrl+F12„Äç„ÅßÁµÇ‰∫Ü  „Äåmu„Çø„Ç∞„ÇíÂâäÈô§„Äç
            s_container_remove(0); }

        else if(!s_container){ //#s_container„ÅåÁÑ°„ÅÑÂ†¥Âêà ÁîüÊàê„Åó„Å¶ÈñãÂßã
            disp_s_container();
            panel=1;

            search_box=document.querySelector('#search_box');
            result_box=document.querySelector('#result');
            replace_box=document.querySelector('#replace_box');
            s_1=document.querySelector('.s_1');
            s_2=document.querySelector('.s_2');
            s_3=document.querySelector('.s_3');
            s_4=document.querySelector('.s_4');
            s_5=document.querySelector('.s_5');
            s_6=document.querySelector('.s_6');
            s_7=document.querySelector('.s_7');
            s_8=document.querySelector('.s_8');
            s_9=document.querySelector('.s_9');

            if(sr_data[0]==1){ // ÈÄ£Á∂öÂá¶ÁêÜ„ÅÆÂ†¥Âêà
                search_word=sr_data[2];
                search_box.value=sr_data[2]; // üü• Ê§úÁ¥¢ÊñáÂ≠óÂèñÂæó

                get_search(); //üî≥RegExp
                result_box_disp();

                if(count_t==0){
                    alert("„ÄÄ‚úÖ ÈÄ£Á∂öÊ§úÁ¥¢„Å´Ë®≠ÂÆö„Åï„Çå„ÅüÊ§úÁ¥¢ÊñáÂ≠ó„Åå„ÅÇ„Çä„Åæ„Åõ„Çì"); }

                if(count_t>0 || count_t==0){

                    setTimeout(()=>{
                        replace_process(); }, 20);

                    setTimeout(()=>{
                        replace_word=sr_data[3]; // üü• ÁΩÆÊèõÊñáÂ≠óÂèñÂæó
                        replace_box.style.display='inline-block';
                        replace_box.value=sr_data[3];

                        cke_1_contents.style.zIndex='11';
                        iframe_body.contentEditable='false'; // Á∑®ÈõÜ‰∏çÂèØ„Å´„Åô„Çã
                        search_box.disabled=true;
                        replace_box.disabled=true;

                        s_2.style.display='inline-block';
                        s_3.style.display='inline-block';
                        s_4.textContent='‰∏ÄÊã¨„ÄÄÈÅ∏Êäû';
                        s_4.style.display='inline-block';
                        if(sr_data[1]==1){
                            t_flag=1;
                            s_4.style.boxShadow='inset -45px 0 0 0 #b0bec5'; }
                        else if(sr_data[1]==2){
                            t_flag=2;
                            s_4.style.boxShadow='inset 45px 0 0 0 #b0bec5'; }
                        s_5.style.display='inline-block';
                        disp_help();
                        s_7.style.display='none';
                        s_8.style.background='#333';
                        s_8.style.display='inline-block';
                        js_cover.style.display='block';

                        add2_mu_style();

                        p_flag=3;
                        if(sr_data[1]==1){ // ‰∏ÄÊã¨ÁΩÆÊèõ
                            t2_process(); } //üî≥RegExp
                        else if(sr_data[1]==2){ // ÈÅ∏ÊäûÁΩÆÊèõ
                            iframe_body.innerHTML=buffer; // ÁΩÆÊèõÂá¶ÁêÜ„Çí‰∏ÄÊó¶„Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô ‚èπ
                            get_search();
                            t_process(); } //üî≥RegExp
                        native_hk=-1;
                        hk=0;
                        next(hk); }, 30);

                    function disp_help(){
                        if(t_flag==1){
                            s_5.innerHTML=
                                '<c>‚á¶</c><c>‚áß</c><c>‚á©</c><c>‚á®</c>ÔºöÁßªÂãï<br>'+
                                '‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà<br>'+
                                'Ê§úÁ¥¢„Åó„ÅüÂÖ®ÁÆáÊâÄ„ÅåÁΩÆÊèõ„Åà„Çâ„Çå„Çã‰∫ã„Å´Ê≥®ÊÑè„Åè„Å†„Åï„ÅÑ<br>'+
                                '‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà<br>'+
                                '<c>OK</c> / <c>Ctrl</c>+<c>Enter</c><br>'+
                                '„ÄÄ„ÄÄ ÔºöÁΩÆÊèõ„ÇíÁ¢∫ÂÆö„Åô„Çã<br>'+
                                '<c>UNDO</c> / <c>Esc</c><br>'+
                                '„ÄÄ„ÄÄ ÔºöÂÖ®„Å¶ÂÖÉ„Å´Êàª„Åô'; }
                        else if(t_flag==2){
                            s_5.innerHTML=
                                '<c>‚á¶</c><c>‚áß</c><c>‚á©</c><c>‚á®</c>ÔºöÁßªÂãï<br>'+
                                '<c>Space</c>ÔºöË®≠ÂÆö / Ëß£Èô§<br>'+
                                '‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà<br>'+
                                'Ë®≠ÂÆö„Åó„ÅüÁÆáÊâÄ„ÅÆ„Åø„Å´ÁΩÆÊèõ„ÇíÂÆüË°å„Åó„Åæ„Åô<br>'+
                                '‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà<br>'+
                                '<c>OK</c> / <c>Ctrl</c>+<c>Enter</c><br>'+
                                '„ÄÄ„ÄÄ ÔºöÁΩÆÊèõ„ÇíÁ¢∫ÂÆö„Åô„Çã<br>'+
                                '<c>UNDO</c> / <c>Esc</c><br>'+
                                '„ÄÄ„ÄÄ ÔºöÂÖ®„Å¶ÂÖÉ„Å´Êàª„Åô'; }}

                }} // ÈÄ£Á∂öÂá¶ÁêÜ„ÅÆÂ†¥Âêà


            p_flag=0; // 0=Ê§úÁ¥¢ÊñáÂ≠ó Êú™Á¢∫ÂÆö
            search_box.focus();
            search_box.onkeydown=function(event){ // üîΩ Ê§úÁ¥¢„ÉÑ„Éº„É´Êìç‰Ωú„ÅÆÈñãÂßãÁÇπ

                if(event.keyCode==13 && !event.ctrlKey){ //„ÄåEnter„Äç„Åßnot„Äå+Ctrl„Äç
                    if(p_flag==0){
                        event.preventDefault();
                        search_word=search_box.value; // üü• Ê§úÁ¥¢ÊñáÂ≠óÂèñÂæó
                        native_hk=-1; // ÂàùÊúüÂåñüÖø
                        get_search();
                        result_box_disp(); }
                    else if(p_flag==1){
                        event.preventDefault();
                        if(search_box.value==search_word){
                            if(caution==1 && t_flag>0 ){
                                s_6.style.display='inline-block';
                                arg_t_or_h=0; } // cautionÊñáÂ≠ó„ÉÅ„Çß„ÉÉ„ÇØ„Å´Ë©≤ÂΩì„Åó„ÄåÁΩÆÊèõ„Äç„ÅØ‰∏çÂèØ
                            else{
                                replace_box.style.display='inline-block';
                                replace_box.focus();
                                arg_t_or_h=0;
                                p_flag=2;
                                replace_process(); }} // Â∑°Âõû„É´„Éº„Éó„ÇíÊäú„Åë„Å¶ ÁΩÆÊèõÂÖ•Âäõ„Å∏
                        else{
                            iframe_body.innerHTML=buffer; // highlight „ÇíÊäú„Åë„ÇãÊôÇ„ÅØ„É™„Çª„ÉÉ„Éà ‚èπ
                            search_word=search_box.value; // üü• Ê§úÁ¥¢ÊñáÂ≠óÂèñÂæó Â§âÊõ¥
                            native_hk=-1; // ÂàùÊúüÂåñüÖø
                            result_box.textContent='‚èé';
                            caution_reset();
                            s_1.style.display='none';
                            arg_t_or_h=0;
                            p_flag=0; // Â∑°Âõû„É´„Éº„Éó„ÇíÊäú„Åë„Å¶ Ê§úÁ¥¢ÊñáÂ≠ó Êú™Á¢∫ÂÆö„Å∏
                            search_box.dispatchEvent(new KeyboardEvent( "keydown", {keyCode: 13})); }
                    }} //„ÄåEnter„ÄçÂÖ•Âäõ

                if(event.keyCode==13 && event.ctrlKey){ //„ÄåEnter+Ctrl„Äç
                    if(search_box.value==''){
                        s_container_remove(1); }} // „ÉÑ„Éº„É´„ÅÆÁµÇ‰∫Ü

                if(event.keyCode==9){ //„ÄåTab„Äç„ÅßÁΩÆÊèõÂÖ•Âäõ„Å∏
                    if(p_flag==0){
                        event.preventDefault(); } //„ÄåTab„Äç„ÅßÂÖ•ÂäõÊû†Â§ñ„Å´Âá∫„Çã„ÅÆ„ÇíÊäëÊ≠¢
                    else if(p_flag==1){
                        event.preventDefault();
                        if(caution==1 && t_flag>0 ){
                            s_6.style.display='inline-block';
                            arg_t_or_h=0; } // cautionÊñáÂ≠ó„ÉÅ„Çß„ÉÉ„ÇØ„Å´Ë©≤ÂΩì„Åó„ÄåÁΩÆÊèõ„Äç„ÅØ‰∏çÂèØ
                        else{
                            replace_box.style.display='inline-block';
                            replace_box.focus();
                            arg_t_or_h=0;
                            p_flag=2;
                            replace_process(); }}} // Â∑°Âõû„É´„Éº„Éó„ÇíÊäú„Åë„Çã

                if(event.keyCode==27 ){ //„ÄåEsc„Äç
                    if(p_flag==1 && t_flag==1){ //„ÄåÂ∑°Âõû„ÄçË°®Á§∫„Çí„É™„Çª„ÉÉ„Éà
                        event.preventDefault();
                        result_box.textContent='T:'+count_t+'‚îÇ-';
                        iframe_body.innerHTML=buffer; // highlight „ÇíÊäú„Åë„ÇãÊôÇ„ÅØ„É™„Çª„ÉÉ„Éà ‚èπ
                        caution_reset();
                        arg_t_or_h=0;
                        p_flag=0; }}

            } // search_box.onkeydown


            search_box.onchange=function(){ //„ÄåEnter„Äç„ÇíÊäº„Åï„ÅöÁßªÂãï„Åó„ÅüÂ†¥Âêà„ÅØÊ§úÁ¥¢Ë™û„ÇíÂÜçË°®Á§∫
                if(search_box.value!==search_word){
                    search_box.style.outline='2px solid #2196f3';
                    search_box.style.outlineOffset='-3px';
                    setTimeout(()=>{
                        search_box.style.outline='none';
                        search_box.value=search_word; }, 500); }}


            s_7.onclick=function(){
                s_container_remove(1); } // s_7.onclick „Äå‚úñ Èñâ„Åò„Çã„Äç„ÅßÁµÇ‰∫Ü


            function result_box_disp(){
                t_flag=0; // t_flag „É™„Çª„ÉÉ„Éà
                arg_t_or_h=0; // „É™„Çª„ÉÉ„Éà
                search_box.disabled=false;
                replace_box.disabled=false;
                s_1.style.display='inline-block';
                s_1.style.boxShadow='none';
                s_2.style.display='none';
                s_3.style.display='none';
                replace_box.style.display='none';
                replace_box.value='';

                if(count_t!=0 && count_h==0){
                    s_1.textContent='TEXTÂá¶ÁêÜ';
                    t_flag=1; // TEXTÂá¶ÁêÜ
                    p_flag=1; // 1=Ê§úÁ¥¢ÊñáÂ≠óÁ¢∫ÂÆö Âá¶ÁêÜÈñãÂßã
                    t_process(); //üî≥RegExp
                    next(hk); }

                if(count_t!=0 && count_h!=0){
                    p_flag=1; // 1=Ê§úÁ¥¢ÊñáÂ≠óÁ¢∫ÂÆö Âá¶ÁêÜÈñãÂßã
                    arg_t_or_h=1; // „Åì„ÅÆÂ†¥Âêà„Å†„Åë„Éï„É©„Ç∞„ÇíÁ´ã„Å¶„Çã
                    t_h_select(); } // TEXT„ÉªHTMLÂá¶ÁêÜÈÅ∏Êäû

                if(count_t==0 && count_h!=0){
                    result_box.textContent='H:'+count_h;
                    s_1.textContent='HTMLÂá¶ÁêÜ';
                    s_1.style.color='#000';
                    t_flag=0;
                    p_flag=1; // 1=Ê§úÁ¥¢ÊñáÂ≠óÁ¢∫ÂÆö Âá¶ÁêÜÈñãÂßã
                    replace_process(); }

                if(count_t==0 && count_h==0){
                    result_box.textContent='T:'+count_t+' H:'+count_h;
                    s_1.textContent='„ÄÄ- - -„ÄÄ';
                    s_1.style.color='#000';
                    p_flag=0; } // 0=Ê§úÁ¥¢ÊñáÂ≠óÊú™Á¢∫ÂÆö Ê§úÁ¥¢Ââç

                function t_h_select(){
                    if(t_or_h==1){
                        t_flag=1; // TEXTÂá¶ÁêÜ
                        result_box.textContent='T:'+count_t+'‚îÇ-';
                        s_1.innerHTML='TEXTÂá¶ÁêÜ„ÄÄ<span>HTML</span>';
                        s_1.style.boxShadow='inset -56px 0 0 0 #cfd8dc';
                        t_process();
                        next(hk); }
                    else{
                        t_flag=0; // HTMLÂá¶ÁêÜ
                        result_box.textContent='H:'+count_h;
                        s_1.innerHTML='<span>TEXT</span>„ÄÄHTMLÂá¶ÁêÜ';
                        s_1.style.boxShadow='inset 54px 0 0 0 #cfd8dc';
                        replace_process(); }

                    s_1.onclick=function(){
                        search_box.focus();
                        native_hk=-1; // ÂàùÊúüÂåñüÖø
                        iframe_body.innerHTML=buffer; // highlight „ÇíÊäú„Åë„ÇãÊôÇ„ÅØ„É™„Çª„ÉÉ„Éà ‚èπ
                        get_search();
                        if(t_or_h==1){
                            t_or_h=0; // HTMLÂá¶ÁêÜ„ÇíÈÅ∏Êäû
                            t_flag=0;
                            s_1.innerHTML='<span>TEXT</span>„ÄÄHTMLÂá¶ÁêÜ';
                            s_1.style.boxShadow='inset 54px 0 0 0 #cfd8dc';
                            result_box.textContent='H:'+count_h;
                            replace_process(); }
                        else{
                            t_or_h=1; // TEXTÂá¶ÁêÜ„ÇíÈÅ∏Êäû
                            t_flag=1;
                            s_1.innerHTML='TEXTÂá¶ÁêÜ„ÄÄ<span>HTML</span>';
                            s_1.style.boxShadow='inset -56px 0 0 0 #cfd8dc';
                            result_box.textContent='T:'+count_t+'‚îÇ-';
                            t_process();
                            next(hk); }}}

                search_box.onblur=function(){ //„ÄåÊ§úÁ¥¢Êû†„Äç„Åå focus„ÇíÁÑ°„Åè„Åó„Åü„Çâ„É™„Çª„ÉÉ„Éà
                    setTimeout( ()=>{
                        if(replace_box.style.display=='none'){ //„ÄåÁΩÆÊèõ„Äç„Å∏ÁßªÂãï„Å®T/HÊìç‰Ωú„ÅØÈô§Â§ñ
                            stop_out(); }}, 10); }

                replace_box.onblur=function(){ //„ÄåÁΩÆÊèõÊû†„Äç„Åå focus„ÇíÁÑ°„Åè„Åó„Åü„Çâ„É™„Çª„ÉÉ„Éà
                    setTimeout( ()=>{
                        if(p_flag!=3){ //„ÄåÁΩÆÊèõ„ÉÅ„Çß„ÉÉ„ÇØÁîªÈù¢„Äç„Å∏ÁßªË°å„ÅØÈô§Â§ñ
                            stop_out(); }}, 10); }

                function stop_out(){
                    if(arg_t_or_h==1){
                        setTimeout(()=>{
                            if(search_box!=document.activeElement){
                                arg_t_or_h=0;
                                stop_out(); }}, 400); }
                    else{
                        if(p_flag==1 || p_flag==2){ // 1=Ê§úÁ¥¢ÊñáÂ≠óÂÖ•Âäõ 2=ÁΩÆÊèõÊñáÂ≠óÂÖ•Âäõ
                            if(t_flag>0){
                                result_box.textContent='T:'+count_t+'‚îÇ-'; }
                            else{
                                result_box.textContent='H:'+count_h; }
                            s_1.style.display='none';
                            replace_box.style.display='none';
                            replace_box.value='';
                            iframe_body.innerHTML=buffer; // highlight „ÇíÊäú„Åë„ÇãÊôÇ„ÅØ„É™„Çª„ÉÉ„Éà ‚èπ
                            native_hk=-1; // ÂàùÊúüÂåñüÖø
                            caution_reset();
                            arg_t_or_h=0;
                            t_flag=0;
                            p_flag=0; }}}

            } // result_box_disp()


            function replace_process(){ // ÁΩÆÊèõÂá¶ÁêÜÂÖ®Ëà¨
                replace_box.focus();

                replace_box.onkeydown=function(event){ // üîΩ ÁΩÆÊèõÊìç‰Ωú„ÅÆÈñãÂßãÁÇπ
                    if(event.keyCode==13 && event.ctrlKey==false){
                        event.preventDefault();
                        replace_word=replace_box.value; // üü• ÁΩÆÊèõÊñáÂ≠óÂèñÂæó
                        if(t_flag>0){
                            t2_process(); } //üî≥RegExp
                        else{
                            h_process(); } //üî≥RegExp
                        js_cover.style.display='block';
                        cke_1_contents.style.zIndex='11';
                        iframe_body.contentEditable='false'; // Á∑®ÈõÜ‰∏çÂèØ„Å´„Åô„Çã
                        search_box.disabled=true;
                        replace_box.disabled=true;
                        s_2.style.display='inline-block';
                        s_3.style.display='inline-block';
                        add2_mu_style();
                        if(t_flag>0 && p_flag==2){
                            s_4.textContent='‰∏ÄÊã¨„ÄÄÈÅ∏Êäû';
                            s_4.style.display='inline-block';
                            s_4.style.boxShadow='inset -45px 0 0 0 #b0bec5';
                            s_5.style.display='inline-block';
                            disp_help();
                            replace_box.blur();
                            next(hk); } //„Äå‰∏ÄÊã¨ÁΩÆÊèõ„Äç„ÅÆ„ÄåÂ∑°ÂõûË°®Á§∫„Äç
                        s_7.style.display='none';
                        if(sr_data[0]==0 && t_flag>0){ // HTMLÂá¶ÁêÜ„ÅÆÊôÇ„ÅØÈùûË°®Á§∫
                            s_8.style.background='#ddd';
                            s_8.style.display='inline-block'; }
                        else if(sr_data[0]==1 && t_flag>0){ // HTMLÂá¶ÁêÜ„ÅÆÊôÇ„ÅØÈùûË°®Á§∫
                            s_8.style.background='#333';
                            s_8.style.display='inline-block'; }
                        p_flag=3; } // 3=ÁΩÆÊèõÂá¶ÁêÜ

                    if(event.keyCode==9 || event.keyCode==27){ //„ÄåTab„Äç„ÄåEsc„Äç„ÅßÂá¶ÁêÜÂâç„Å´Êàª„Çã
                        event.preventDefault();
                        result_box.textContent='„ÄÄ';
                        s_1.style.display='none';
                        replace_box.style.display='none';
                        replace_box.value='';
                        if(t_flag==1){
                            iframe_body.innerHTML=buffer; } // ÁΩÆÊèõÂá¶ÁêÜ„ÇíUNDO ‚èπ
                        search_box.focus();
                        p_flag=0; }} // 0=Ê§úÁ¥¢ÊñáÂ≠ó Êú™Á¢∫ÂÆö

                s_2.onclick=function(){ //„ÄåOK„Äç„Éú„Çø„É≥„Åß‰∏ÄÊã¨ÁΩÆÊèõÁ¢∫ÂÆö
                    js_cover_remove();
                    delete_mu(); // mu„Çø„Ç∞„ÇíÂâäÈô§
                    result_box.textContent='„ÄÄ'; // Ê§úÁ¥¢ÁµêÊûú„ÅØÂ§âÊõ¥„Åï„Çå„Çã
                    s_1.style.display='none';
                    replace_box.style.display='none';
                    replace_box.value='';
                    s_8.style.display='none';
                    reset_mu_style();
                    if(t_flag>0){
                        t_flag=0;
                        native_hk=-1; } // ÂàùÊúüÂåñüÖø
                    search_box.focus();
                    p_flag=0; } // 0=Ê§úÁ¥¢ÊñáÂ≠ó Êú™Á¢∫ÂÆö

                s_3.onclick=function(){ //„ÄåUNDO„Äç„Éú„Çø„É≥
                    js_cover_remove();
                    iframe_body.innerHTML=buffer; // ÁΩÆÊèõÂá¶ÁêÜ„ÇíUNDO ‚èπ
                    get_search();
                    s_8.style.display='none';
                    reset_mu_style();
                    if(t_flag>0){
                        t_flag=1;
                        t_process(); //üî≥RegExp
                        next(hk); } // UNDOÊôÇ„ÅØ„Äå‰∏ÄÊã¨ÁΩÆÊèõ„Äç„ÅÆ„ÄåÂ∑°ÂõûË°®Á§∫„Äç
                    replace_box.focus();
                    p_flag=2; } // 2=Ê§úÁ¥¢ÊñáÂ≠óÁ¢∫ÂÆö ÁΩÆÊèõÊñáÂ≠óÂÖ•Âäõ Âá¶ÁêÜÈÅ∏Êäû

                s_4.onclick=function(){ //„Äå‰∏ÄÊã¨„ÉªÈÅ∏Êäû„Äç„Éú„Çø„É≥
                    if(t_flag==1){
                        t_flag=2; //„ÄåÈÅ∏ÊäûÁΩÆÊèõ„Äç„Å´Â§âÊõ¥
                        s_4.style.boxShadow='inset 45px 0 0 0 #b0bec5';
                        select_replace(); } //„ÄåÈÅ∏ÊäûÁΩÆÊèõ„Äç„ÇíÂÆüË°å
                    else if(t_flag==2){
                        t_flag=1; //„Äå‰∏ÄÊã¨ÁΩÆÊèõ„Äç„Å´Â§âÊõ¥
                        s_4.style.boxShadow='inset -45px 0 0 0 #b0bec5';
                        all_replace(); }
                    disp_help(); }

                s_4.addEventListener('mouseover', ()=>{
                    if(t_flag==2){
                        s_5.innerHTML=
                            'ÔΩ¢‰∏ÄÊã¨ÔΩ£ „Å´ÂàáÊèõ„Åà„ÇãÈöõ„Å´<br>'+
                            'ÈÅ∏Êäû„Åó„ÅüÁΩÆÊèõ„ÅÆË®≠ÂÆö„ÅØ<br>'+
                            'ÂÖ®„Å¶„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åô'; }}, false);

                s_4.addEventListener('mouseleave', ()=>{
                    disp_help(); }, false);

                s_8.addEventListener('mouseover', ()=>{
                    if(sr_data[0]==0){
                        s_5.innerHTML=
                            '<c>C</c>ÔºöÈÄ£Á∂öÂá¶ÁêÜ„É¢„Éº„ÉâON<br>'+
                            '‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà<br>'+
                            'ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíÁôªÈå≤„Åó„Åæ„Åô<br>'+
                            '‚Ä∫ ÔΩ¢Ê§úÁ¥¢ÊñáÂ≠óÔΩ£‚ÄÜÔΩ¢ÁΩÆÊèõÊñáÂ≠óÔΩ£‚ÄÜ<br>'+
                            '‚Ä∫ ÔΩ¢‰∏ÄÊã¨ / ÈÅ∏ÊäûÔΩ£‚ÄÜ„ÅÆÈÅ∏Êäû<br>'+
                            'ÈÄ£Á∂öÂá¶ÁêÜ„ÅØÊ¨°Âõû„ÅÆËµ∑ÂãïÊôÇ<br>'+
                            '„Åã„ÇâÂÆüË°å„Åï„Çå„Åæ„Åô'; }
                    else if(sr_data[0]==1){
                        s_5.innerHTML=
                            '<c>C</c>ÔºöÈÄ£Á∂öÂá¶ÁêÜ„ÇíÁµÇ‰∫Ü<br>'+
                            '‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà<br>'+
                            '<c>Shift</c>+<c>C</c>Ôºö„É¢„Éº„ÉâÊõ¥Êñ∞<br>'+
                            '‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà<br>'+
                            '‚ÄÜÔΩ¢Shift+Click„Äç„ÅÆÊìç‰Ωú„Åß<br>'+
                            'ÁèæÂú®„ÅÆÂá¶ÁêÜË®≠ÂÆö<br>'+
                            '‚Ä∫ ÔΩ¢Ê§úÁ¥¢ÊñáÂ≠óÔΩ£‚ÄÜÔΩ¢ÁΩÆÊèõÊñáÂ≠óÔΩ£‚ÄÜ<br>'+
                            '‚Ä∫ ÔΩ¢‰∏ÄÊã¨ / ÈÅ∏ÊäûÔΩ£‚ÄÜ„ÅÆÈÅ∏Êäû<br>'+
                            '„ÇíÁôªÈå≤„Åó„Åæ„Åô<br>'+
                            'Ê¨°Âõû„Åã„Çâ„Åì„ÅÆÂá¶ÁêÜË®≠ÂÆö„Åå<br>'+
                            'ÂÆüË°å„Åï„Çå„Åæ„Åô'; }}, false);

                s_8.addEventListener('mouseleave', ()=>{
                    disp_help(); }, false);

                s_9.addEventListener('mouseover', ()=>{
                    s_5.innerHTML=
                        'Êìç‰Ωú„Éû„Éã„É•„Ç¢„É´„ÇíË°®Á§∫'; });

                s_9.addEventListener('mouseleave', ()=>{
                    disp_help(); }, false);

                s_9.onclick=function(){
                    window.open("https://ameblo.jp/personwritep/entry-12758975310.html", '_blank'); }


                function disp_help(){
                    if(t_flag==1){
                        s_5.innerHTML=
                            '<c>‚á¶</c><c>‚áß</c><c>‚á©</c><c>‚á®</c>ÔºöÁßªÂãï<br>'+
                            '‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà<br>'+
                            'Ê§úÁ¥¢„Åó„ÅüÂÖ®ÁÆáÊâÄ„ÅåÁΩÆÊèõ„Åà„Çâ„Çå„Çã‰∫ã„Å´Ê≥®ÊÑè„Åè„Å†„Åï„ÅÑ<br>'+
                            '‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà<br>'+
                            '<c>OK</c> / <c>Ctrl</c>+<c>Enter</c><br>'+
                            '„ÄÄ„ÄÄ ÔºöÁΩÆÊèõ„ÇíÁ¢∫ÂÆö„Åô„Çã<br>'+
                            '<c>UNDO</c> / <c>Esc</c><br>'+
                            '„ÄÄ„ÄÄ ÔºöÂÖ®„Å¶ÂÖÉ„Å´Êàª„Åô'; }
                    else if(t_flag==2){
                        s_5.innerHTML=
                            '<c>‚á¶</c><c>‚áß</c><c>‚á©</c><c>‚á®</c>ÔºöÁßªÂãï<br>'+
                            '<c>Space</c>ÔºöË®≠ÂÆö / Ëß£Èô§<br>'+
                            '‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà<br>'+
                            'Ë®≠ÂÆö„Åó„ÅüÁÆáÊâÄ„ÅÆ„Åø„Å´ÁΩÆÊèõ„ÇíÂÆüË°å„Åó„Åæ„Åô<br>'+
                            '‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà‚îà<br>'+
                            '<c>OK</c> / <c>Ctrl</c>+<c>Enter</c><br>'+
                            '„ÄÄ„ÄÄ ÔºöÁΩÆÊèõ„ÇíÁ¢∫ÂÆö„Åô„Çã<br>'+
                            '<c>UNDO</c> / <c>Esc</c><br>'+
                            '„ÄÄ„ÄÄ ÔºöÂÖ®„Å¶ÂÖÉ„Å´Êàª„Åô'; }}


                function all_replace(){ //„Äå‰∏ÄÊã¨ÁΩÆÊèõÂá¶ÁêÜ„Äç
                    t2_process(); //üî≥RegExp
                    next(hk); }

                function select_replace(){ //„ÄåÈÅ∏ÊäûÁΩÆÊèõÂá¶ÁêÜ„Äç
                    iframe_body.innerHTML=buffer; // ÁΩÆÊèõÂá¶ÁêÜ„Çí‰∏ÄÊó¶„Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô ‚èπ
                    get_search();
                    t_process(); //üî≥RegExp
                    next(hk); }


                s_8.onclick=function(event){ //„ÄåC„ÄçÈÄ£Á∂öÂá¶ÁêÜ„É¢„Éº„Éâ„Éú„Çø„É≥

                    if(sr_data[0]==0){ // ÈÄ£Á∂öÂá¶ÁêÜ„É¢„Éº„ÉâOFF
                        let result=window.confirm(
                            "„ÄåOK„ÄçÔºö ÈÄ£Á∂öÂá¶ÁêÜ„É¢„Éº„Éâ„ÇíON„Å´„Åó„Åæ„Åô\n"+
                            "„ÄÄÁèæÂú®ÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Çã „ÄåÊ§úÁ¥¢ÊñáÂ≠ó„Äç„ÄåÁΩÆÊèõÊñáÂ≠ó„Äç„Äå‰∏ÄÊã¨ / ÈÅ∏Êäû„Äç\n"+
                            "„ÄÄ„ÅÆÂá¶ÁêÜÊåáÂÆö„Çí„ÄÅ„Åì„ÅÆ„ÉÑ„Éº„É´„ÇíËµ∑Âãï„Åô„ÇãÂ∫¶„Å´ÂÜçÁèæ„ÅóÂÆüË°å„Åß„Åç„Åæ„Åô");
                        if(result){
                            sr_data[0]=1;
                            sr_data[1]=t_flag;
                            sr_data[2]=search_word;
                            sr_data[3]=replace_word;
                            let write_json=JSON.stringify(sr_data);
                            localStorage.setItem('sr_editor', write_json); // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏ ‰øùÂ≠òÂêç
                            s_8.style.background='#333'; }
                        else{
                            s_8.style.background='#ddd'; }}

                    else if(sr_data[0]==1){ // ÈÄ£Á∂öÂá¶ÁêÜ„É¢„Éº„ÉâON
                        if(event.shiftKey){
                            let result=window.confirm(
                                "„ÄåOK„ÄçÔºö ÈÄ£Á∂öÂá¶ÁêÜ„É¢„Éº„Éâ„ÅÆÂá¶ÁêÜÊåáÂÆö„ÇíÊõ¥Êñ∞„Åó„Åæ„Åô\n"+
                                "„ÄÄÁèæÂú®ÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Çã „ÄåÊ§úÁ¥¢ÊñáÂ≠ó„Äç„ÄåÁΩÆÊèõÊñáÂ≠ó„Äç„Äå‰∏ÄÊã¨ / ÈÅ∏Êäû„Äç\n"+
                                "„ÄÄ„ÅÆÂá¶ÁêÜÊåáÂÆö„Çí„ÄÅ„Åì„ÅÆ„ÉÑ„Éº„É´„ÇíËµ∑Âãï„Åô„ÇãÂ∫¶„Å´ÂÜçÁèæ„ÅóÂÆüË°å„Åó„Åæ„Åô");
                            if(result){
                                sr_data[0]=1;
                                sr_data[1]=t_flag;
                                sr_data[2]=search_word;
                                sr_data[3]=replace_word;
                                let write_json=JSON.stringify(sr_data);
                                localStorage.setItem('sr_editor', write_json); }} // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏ ‰øùÂ≠òÂêç
                        else{
                            let result=window.confirm(
                                "„ÄåOK„ÄçÔºö ÈÄ£Á∂öÂá¶ÁêÜ„É¢„Éº„Éâ„ÇíOFF„Å´„Åó„Åæ„Åô\n"+
                                "„ÄÄÁèæÂú®„ÅÆ„ÄåÊ§úÁ¥¢ÊñáÂ≠ó„Äç„ÄåÁΩÆÊèõÊñáÂ≠ó„Äç„Å®„Äå‰∏ÄÊã¨ / ÈÅ∏Êäû„Äç„ÅÆÂá¶ÁêÜÊåáÂÆö„ÅÆ\n"+
                                "„ÄÄÁôªÈå≤„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÄÇ ÂÆüË°å„Åô„Çã„Å´„ÅØ„ÄåOK„Äç„ÇíÊäº„Åó„Åæ„Åô");
                            if(result){
                                sr_data[0]=0;
                                sr_data[1]=1;
                                sr_data[2]='';
                                sr_data[3]='';
                                let write_json=JSON.stringify(sr_data);
                                localStorage.setItem('sr_editor', write_json); // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏ ‰øùÂ≠òÂêç

                                iframe_body.innerHTML=buffer; // ÁΩÆÊèõÂá¶ÁêÜ„ÇíUNDO ‚èπ
                                reset_mu_style();

                                js_cover_remove();
                                s_8.style.background='#ddd';
                                s_8.style.display='none';
                                s_1.style.display='none';
                                result_box.textContent='„ÄÄ';
                                replace_box.value='';
                                replace_box.style.display='none';
                                search_box.value='';
                                search_box.focus();
                                p_flag=0; } // 0=Ê§úÁ¥¢ÊñáÂ≠ó Êú™Á¢∫ÂÆö
                            else{
                                s_8.style.background='#000'; }}}

                } //„ÄåC„ÄçÈÄ£Á∂öÂá¶ÁêÜ„É¢„Éº„Éâ„Éú„Çø„É≥

            } // replace_process()
        } // #s_container „ÅåÁÑ°„ÅÑÂ†¥Âêà„ÄåCtrl+F12„Äç„ÅßÈñãÂßã

    } // search_replace()



    function next(hk){ //„ÄåÂ∑°ÂõûË°®Á§∫„Äç„ÄåÈÅ∏ÊäûÁΩÆÊèõ„Äç„Ç≥„Éº„Éâ
        let mark=iframe_body.querySelectorAll('mu');

        if(native_hk!=-1){ // Âü∫Êú¨ÁöÑ„Å´ÂâçÂõû„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÂÜçÁèæüÖø
            hk=native_hk; }
        else if(native_hk==-1 || !native_hk){ // ÂàùÊúü„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÁîüÊàêüÖø
            if(mark.length==1){ hk=0; } // 1ÂÄã„Å™„ÇâÂç≥Ê±∫ÂÆö
            else{
                let near_n; // ‰∏≠Â§ÆÂæåÊñπ„ÅÆË¶ÅÁ¥†„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
                let editor_hight=editor_iframe.clientHeight; // Á∑®ÈõÜÊû†„ÅÆÈ´ò„Åï
                for(let k=1; k<mark.length; k++){ // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ‰∏≠Â§Æ„ÇíË∂ä„Åà„Çãmark[k]„ÇíÂèñÂæó
                    if(mark[k].getBoundingClientRect().top>editor_hight/2){
                        near_n=k;
                        break; }}
                if(!near_n){ // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ‰∏≠Â§Æ„Çà„ÇäÂæåÊñπ„Å´mark[k]„Åå„Å™„ÅÑÂ†¥Âêà
                    hk=mark.length-1; }
                else{ // Áõ¥Ââç„ÅÆ mark[k]„Å®ÊØîËºÉ„Åó„Å¶„ÄÅËøë„ÅÑÊñπ„ÇíÊé°„Çã
                    if(mark[near_n].getBoundingClientRect().top>
                       editor_hight-mark[near_n-1].getBoundingClientRect().top){
                        hk=near_n-1; }
                    else{
                        hk=near_n; }}}}

        view(hk);
        try{
            mark[hk].classList.add("h"); } // ÊúÄÂàù„ÅÆ„Éè„Ç§„É©„Ç§„ÉàËâ≤„ÇíÂ§âÊõ¥
        catch(e){ ; }

        result_box.textContent='T:'+count_t+'‚îÇ'+(hk+1);

        document.addEventListener("keydown", check_arrow); // document„ÅØÂÖà„Å´ÊåáÂÆö
        iframe_doc=editor_iframe.contentWindow.document;
        if(iframe_doc){
            iframe_doc.addEventListener("keydown", check_arrow); }// iframe„ÅØÂæå„Å´ÊåáÂÆö

        function check_arrow(event){
            if(event.keyCode==38){ //„Äå‚Üë„Äç
                if(p_flag>0 && t_flag>0){
                    event.preventDefault();
                    back(); }}
            if(event.keyCode==37){ //„Äå‚Üê„Äç
                if(p_flag==3 && t_flag>0){
                    event.preventDefault();
                    back(); }}
            if(event.keyCode==40){ //„Äå‚Üì„Äç
                if(p_flag>0 && t_flag>0){
                    event.preventDefault();
                    forward() }}
            if(event.keyCode==39){ //„Äå‚Üí„Äç
                if(p_flag==3 && t_flag>0){
                    event.preventDefault();
                    forward() }}
            if(event.keyCode==32){ //„ÄåSpace„Äç„ÅßÂÄãÂà•„Å´ÁΩÆÊèõ„ÅÆË®≠ÂÆö/Ëß£Èô§
                if(p_flag==3 && t_flag==2){
                    event.preventDefault();
                    if(mark[hk].textContent==search_word){
                        mark[hk].textContent=replace_word; }
                    else if(mark[hk].textContent==replace_word){
                        mark[hk].textContent=search_word; }}}

            native_hk=hk;

            function back(){
                if(hk>0){ // Ê®ôÊ∫ñ„ÅÆ„Éè„Ç§„É©„Ç§„ÉàËâ≤„Å´Êàª„Åô
                    mark[hk].classList.remove("h");
                    hk-=1; }
                else if(hk==0){
                    hk=0; }
                result_box.textContent='T:'+count_t+'‚îÇ'+(hk+1);
                try{
                    mark[hk].classList.add("h"); }
                catch(e){ ; }
                view(hk); }

            function forward(){
                if(hk<mark.length-1){ // Ê®ôÊ∫ñ„ÅÆ„Éè„Ç§„É©„Ç§„ÉàËâ≤„Å´Êàª„Åô
                    mark[hk].classList.remove("h");
                    hk+=1; }
                else if(hk==mark.length-1){
                    hk=mark.length-1; }
                result_box.textContent='T:'+count_t+'‚îÇ'+(hk+1);
                try{
                    mark[hk].classList.add("h"); }
                catch(e){ ; }
                view(hk); }

        }} // next() „Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂèñÂæóüÖø


    function view(hk){
        let l_body=document.querySelector('body.l-body');
        let mark=iframe_body.querySelectorAll('mu');
        try{
            mark[hk].scrollIntoView({block: "center"});
            iframe_html.scrollBy(0, -12); } // -1ÔΩû-24  -12„Åå„ÇØ„É™„Éº„Éó„ÇíÁÑ°„Åè„ÅôÊúÄÈÅ©ÂÄ§
        catch(e){ ; }
        l_body.scrollIntoView(); }



    function get_search(){
        search_word_es=escapeRegExp(search_word); //üî≥RegExp
        editor_iframe=document.querySelector('.cke_wysiwyg_frame'); // „Åì„Åì„ÅßÂèñÂæó

        if(editor_iframe){ //„ÄåÈÄöÂ∏∏Ë°®Á§∫„Äç„ÅåÂÆüË°åÊù°‰ª∂
            iframe_doc=editor_iframe.contentWindow.document;
            iframe_body=iframe_doc.querySelector('.cke_editable');
            buffer=iframe_body.innerHTML; // „Éè„Ç§„É©„Ç§„ÉàË°®Á§∫„ÅÆ„Åü„ÇÅ„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„Çí‰øùÂ≠ò üü¶

            buffer_arr=[]; // ÂàáÂàÜ„Åë„Åü„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„ÇíÂÖ•„Çå„ÇãÈÖçÂàó
            let sa=0;
            let sb=0;
            let sc=0;
            let result_t;
            let result_h;

            let n=buffer.split('<').length-1; // ÈñãÂßã„ÉªÁµÇÁµê„ÇíÂê´„ÇÄÂÖ®„Çø„Ç∞Êï∞„ÇíÂèñÂæó
            for(let k=0; k<n; k++){
                sb=buffer.indexOf('>', sa);
                buffer_arr.push(buffer.slice(sa, sb+1)); //„Çø„Ç∞Êã¨ÂºßÂÜÖ 1ÂÄã„ÇíÈÖçÂàó„Å´ÂèéÁ¥ç
                sc=buffer.indexOf('<', sb+1);
                if(sc==-1){ break; } // ÊñáÊõ∏„ÅÆÊú´Â∞æ„ÅßÂæå„Åå„Å™„ÅÑÂ†¥Âêà„Å´ÁµÇ‰∫Ü
                else{
                    buffer_arr.push(buffer.slice(sb+1, sc)); //„Çø„Ç∞Êã¨ÂºßÂ§ñ 1ÂÄã„ÇíÈÖçÂàó„Å´ÂèéÁ¥ç
                    sa=sc; }}

            avoid=[]; //„Äåstyle„Çø„Ç∞„Äç„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíË®òÈå≤
            for(let i=0; i<n; i++){
                if(buffer_arr[i*2].match(new RegExp('<style'))){
                    avoid.push(i*2); }}

            count_t=0; // „ÉÜ„Ç≠„Çπ„Éà„Éé„Éº„Éâ„ÅÆ„Éí„ÉÉ„ÉàÊï∞
            for(let i=0; i<n; i++){ //ÈÖçÂàó„ÅÆÂ•áÊï∞„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅØ„Çø„Ç∞Êã¨ÂºßÂ§ñÔºàTEXTÔºâ
                if(buffer_arr[i*2+1]){
                    result_t=buffer_arr[i*2+1].match(new RegExp(search_word_es, 'g')); //üî≥RegExp
                    if(result_t){
                        count_t+=result_t.length; }}}
            count_h=0; // HTML„Ç≥„Éº„Éâ„ÅÆ„Éí„ÉÉ„ÉàÊï∞
            for(let i=0; i<n; i++){ //ÈÖçÂàó„ÅÆÂÅ∂Êï∞„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅØ„Çø„Ç∞Êã¨ÂºßÂÜÖÔºàHTML„Ç≥„Éº„ÉâÔºâ
                result_h=buffer_arr[i*2].match(new RegExp(search_word_es, 'g')); //üî≥RegExp
                if(result_h){
                    count_h+=result_h.length; }}

            caution_ck(); //„Äåno-break space„Äç„ÄåÊñáÂ≠óÂÆü‰ΩìÂèÇÁÖß„Äç„ÅÆÂèØËÉΩÊÄß„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        }

        title_test(); // üü©

    } // get_search()



    function caution_ck(){
        caution=0;
        document.querySelector('.c_nb').style.display='none';
        document.querySelector('.c_lt').style.display='none';
        document.querySelector('.c_gt').style.display='none';
        document.querySelector('.c_am').style.display='none';

        if('&nbsp;'.match(new RegExp(search_word_es))){
            if(buffer.match(new RegExp(/&nbsp;/))){
                document.querySelector('.c_nb').style.display='inline';
                caution=1; }}
        if('&lt;'.match(new RegExp(search_word_es))){
            if(buffer.match(new RegExp(/&lt;/))){
                document.querySelector('.c_lt').style.display='inline';
                caution=1; }}
        if('&gt;'.match(new RegExp(search_word_es))){
            if(buffer.match(new RegExp(/&gt;/))){
                document.querySelector('.c_gt').style.display='inline';
                caution=1; }}
        if('&amp;'.match(new RegExp(search_word_es))){
            if(buffer.match(new RegExp(/&amp;/))){
                document.querySelector('.c_am').style.display='inline';
                caution=1; }}

    } // caution_ck()


    function caution_reset(){
        s_6.style.display='none'; }


    function t_process(){
        let rep_word='<mu>'+ search_word +'</mu>';
        t_replace(rep_word); }


    function t2_process(){
        let rep_word=replace_word;
        t_replace(rep_word); }


    function t_replace(rep_word){
        let n=buffer.split('<').length-1; // ÈñãÂßã„ÉªÁµÇÁµê„ÇíÂê´„ÇÄÂÖ®„Çø„Ç∞Êï∞„ÇíÂèñÂæó
        for(let i=0; i<n; i++){ //ÈÖçÂàó„ÅÆÂ•áÊï∞„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅØ„Çø„Ç∞Êã¨ÂºßÂ§ñÔºàTEXTÔºâ
            let pass=1;
            for(let j=0; j<avoid.length; j++){
                if(avoid[j]==i*2){
                    pass=0;
                    break; }}
            if(pass!=0 && buffer_arr[i*2+1]){
                buffer_arr[i*2+1]=
                    buffer_arr[i*2+1].replace(new RegExp(search_word_es, 'g'), rep_word); }} //üî≥RegExp
        iframe_body.innerHTML=buffer_arr.join(''); }


    function h_process(){
        let rep_word=replace_word;
        let n=buffer.split('<').length-1; // ÈñãÂßã„ÉªÁµÇÁµê„ÇíÂê´„ÇÄÂÖ®„Çø„Ç∞Êï∞„ÇíÂèñÂæó
        for(let i=0; i<n; i++){ //ÈÖçÂàó„ÅÆÂÅ∂Êï∞„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅØ„Çø„Ç∞Êã¨ÂºßÂÜÖÔºàHTML„Ç≥„Éº„ÉâÔºâ
            if(buffer_arr[i*2]){
                buffer_arr[i*2]=
                    buffer_arr[i*2].replace(new RegExp(search_word_es, 'g'), rep_word); }} //üî≥RegExp
        iframe_body.innerHTML=buffer_arr.join(''); }



    function add_mu_style(){
        editor_iframe=document.querySelector('.cke_wysiwyg_frame');
        if(editor_iframe){ //„ÄåÈÄöÂ∏∏Ë°®Á§∫„Äç„ÅÆÂ†¥Âêà
            iframe_doc=editor_iframe.contentWindow.document;
            iframe_html=iframe_doc.querySelector('html');
            let css_iframe=
                '.cke_editable mu { background: #ffcc00; } '+ // „Éè„Ç§„É©„Ç§„Éà mu„Çø„Ç∞ËÉåÊôØËâ≤‚≠ï
                '.cke_editable mu.h { background: #85ff00; }'; // „Éï„Ç©„Éº„Ç´„Çπ mu„Çø„Ç∞ËÉåÊôØËâ≤‚≠ï
            let style_tag_iframe=iframe_doc.createElement("style");
            style_tag_iframe.type="text/css";
            style_tag_iframe.setAttribute("class", "ep");
            style_tag_iframe.appendChild(document.createTextNode(css_iframe));
            if(iframe_html.querySelector('.ep')){
                iframe_html.querySelector('.ep').remove(); }
            iframe_html.appendChild(style_tag_iframe); }}


    function add2_mu_style(){
        if(replace_word==''){
            replace_box.setAttribute('placeholder', "„ÄÄ„ÄÄ„ÄÄüü¶ ÂâäÈô§„É¢„Éº„Éâ");
            replace_box.style.border='2px solid #009688';
            replace_box.style.background='#090907';
            replace_box.style.filter='invert(1)';
            if(t_flag>0){
                if(iframe_html.querySelector('.ep')){ // „Éè„Ç§„É©„Ç§„Éà„Éª„Éï„Ç©„Éº„Ç´„Çπ mu„Çø„Ç∞„ÄåÂâäÈô§„É¢„Éº„Éâ„Äç‚≠ï
                    iframe_html.querySelector('.ep').textContent=
                        '.cke_editable mu { box-shadow: 0 0 0 2px #ffcc00; background: #ffcc00; } '+
                        '.cke_editable mu.h { filter: opacity(1); '+
                        'box-shadow: 0 0 0 2px red; background: #fce4ec; }'; }}}}


    function reset_mu_style(){
        replace_box.setAttribute('placeholder', " ÁΩÆÊèõÊñáÂ≠ó");
        replace_box.style.border='';
        replace_box.style.background='';
        replace_box.style.filter='none';
        if(t_flag>0){
            if(iframe_html.querySelector('.ep')){ // „Éè„Ç§„É©„Ç§„Éà„Éª„Éï„Ç©„Éº„Ç´„Çπ mu„Çø„Ç∞ „Éá„Éï„Ç©„É´„Éà ‚≠ï
                iframe_html.querySelector('.ep').textContent=
                    '.cke_editable mu { background: #ffcc00; } '+
                    '.cke_editable mu.h { background: #85ff00; }'; }}}


    function delete_mu(){
        editor_iframe=document.querySelector('.cke_wysiwyg_frame');
        if(editor_iframe){ //„ÄåÈÄöÂ∏∏Ë°®Á§∫„Äç„ÅÆÂ†¥Âêà
            iframe_doc=editor_iframe.contentWindow.document;
            iframe_body=iframe_doc.querySelector('.cke_editable');
            if(iframe_body){
                let mark=iframe_body.querySelectorAll('mu');
                if(mark.length!=0){
                    iframe_body.innerHTML=
                        iframe_body.innerHTML.replace(new RegExp('<mu.*?>', 'g'), ''); }}}} //üî≥RegExp


    function escapeRegExp(string){
        let reRegExp=/[\\^$.*+?()[\]{}|]/g;
        let reHasRegExp=new RegExp(reRegExp.source);
        return (string && reHasRegExp.test(string))
            ? string.replace(reRegExp, '\\$&')
        : string; }



    function title_test(){ // üü©
        let s_container=document.querySelector('#s_container');
        if(s_container){
            if(title_search()){
                title_sw();
                let sw=document.querySelector('#title_sw');
                if(sw){
                    sw.onclick=function(){
                        if(panel==1 && p_flag!=3){
                            panel=0;
                            s_container.style.display='none'; }
                        else{
                            panel=1;
                            s_container.style.display='block'; }}}}
            else{
                title_sw_remove(); }
        }} // title_test()


    function title_sw(){
        let sw=
            '<div id="title_sw">Title'+
            '<style>'+
            '#title_sw { position: absolute; top: 12px; left: calc(50% - 540px); z-index: 11; '+
            'font: 16px Meiryo; color: #000; padding: 11px 5px 7px; border: 1px solid #aaa; '+
            'border-radius: 4px; background: #85ff00; cursor: pointer; user-select: none; } '+
            '.p-title { z-index: 11 !important; } '+
            '</style></div>';

        let l_body=document.querySelector('body.l-body');
        if(!l_body.querySelector('#title_sw')){
            l_body.insertAdjacentHTML('beforeend', sw); }}


    function title_sw_remove(){
        if(document.querySelector('#title_sw')){
            document.querySelector('#title_sw').remove(); }}


    function title_search(){
        let title_text='';
        let tilte_input=document.querySelector('.p-title__text');
        if(tilte_input){
            title_text=tilte_input.value;
            search_word_es=escapeRegExp(search_word); //üî≥RegExp
            let result_title=title_text.match(new RegExp(search_word_es, 'g')); //üî≥RegExp
            if(result_title){
                return true; }
            else{
                return false; }}
        else{
            return false; }}



    function publish(){
        let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
        if(!editor_iframe){ //„ÄåHTMLË°®Á§∫„ÄçÁ∑®ÈõÜÁîªÈù¢„ÅÆÂ†¥Âêà
            alert("‚õî„ÄÄÈÄöÂ∏∏Ë°®Á§∫ÁîªÈù¢„Å´Êàª„Å£„Å¶ÊäïÁ®ø„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); }
        if(editor_iframe){ //„ÄåÈÄöÂ∏∏Ë°®Á§∫„ÄçÁ∑®ÈõÜÁîªÈù¢„ÅÆÂ†¥Âêà
            let publish0=document.querySelector('.p-submit__container button[publishflg="0"]');
            if(publish0){
                publish0.click(); }}}

} // main()
